<div class="<%= comment_class(comment) %>">
  
  <div class="content">
    <%= format_text_for_display(comment.content) %>
  </div>
  
  <% if comment.user.has_exid? %>
    <p><%= link_public_user_avatar(comment.user, :mini) %> <%= link_to comment.user.public_name, user_path(comment.user.id) %></p>
  <% else %>
    <p><strong><%= comment.user.public_name %></strong></p>
  <% end %>
  
  <p class="comment_time"><span><%= link_to time_ago_in_words(comment.updated_at) + ' ago', comment_path(comment) %> </span></p>
  
  <% if comment.parent_removed %>
    <p class="removed">The comment preceding this comment has been deleted</p>
  <% end %>
  
  <p class="actions">
  <span class="comment_actions">
    <% if current_user %>
      <% if !comment.question.is_private %>
      <%= link_to 'reply', '#', :onclick => "show_element($('#comment_reply_to_#{comment.id}'));" %> 
      <% else %>
        <p>Replies locked, question is now private.</p>
      <% end %>
    <% end %>
    
    <% if current_user && (current_user.id == comment.user_id) %>
      <%= link_to 'edit', '#', :onclick => "show_element($('#comment_edit_for_#{comment.id}'));" %>
      <% if parent_comment.present? %>
        <%= link_to 'delete', comment_path(comment, 
                                         :parent_comment_id => parent_comment.id), 
                                         :method => :delete, 
                                         :confirm => 'Are you sure you want to delete this comment?', 
                                         :remote => true %>
      <% else %>
        <%= link_to 'delete', comment_path(comment), 
                                         :method => :delete, 
                                         :confirm => 'Are you sure you want to delete this comment?', 
                                         :remote => true %>
      <% end %>
    <% end %>
  </span>
  
  </p>
  <br class="clearing" />
</div>
<% if current_user %>
<div id="comment_reply_to_<%= comment.id %>" style="display:none" class="commentfield_container">
  <%= form_tag(comments_path, :id => 'comment-form-reply', :remote => true) do %>
    <%= link_public_user_avatar(current_user, :thumb) %>
    <div class="commentfield">
    <%= text_area_tag 'comment[content]', nil, {:id => "comment_reply_#{comment.id}", :cols => 20, :rows => 5} %>
    <%= hidden_field_tag 'comment[question_id]', comment.question.id %>
    <%= hidden_field_tag 'comment[parent_id]', comment.id %>
    <!-- parent_comment being present means that we called this template from the parent comment's view page 
         and we're passing the parent_comment id along to the request to create a new comment so we can then 
         render the correct thing (the parent comment and it's children) after the comment reply action is executed -->
    <% if parent_comment.present? %>
      <%= hidden_field_tag 'parent_comment_id', parent_comment.id %>
    <% end %>
    <%= link_to 'Cancel', '#', :onclick => "hide_element($('#comment_reply_to_#{comment.id}'));" %>
    <%= submit_tag "Post", {:id => 'comment-submit', :class => 'btn primary'} %>
    </div>
  <% end %>
  <br class="clearing" />
</div>

<div id="comment_edit_for_<%= comment.id %>" style="display:none" class="commentfield_container">
  <%= form_tag(comment_path(:id => comment.id), :id => 'comment-form-edit', :remote => true, :method => :put) do %>
    <%= link_public_user_avatar(current_user, :thumb) %>
    <div class="commentfield">
    <%= text_area_tag 'comment[content]', comment.content, {:id => "comment_edit_#{comment.id}", :cols => 20, :rows => 5} %>
    <!-- parent_comment being present means that we called this template from the parent comment's view page 
         and we're passing the parent_comment id along to the request to edit that comment so we can then 
         render the correct thing after the comment edit is executed, because the originating page is a comment and it's 
         children and not the whole list of comments -->
    <% if parent_comment.present? %>
      <%= hidden_field_tag 'parent_comment_id', parent_comment.id %>
    <% end %>
    <%= link_to 'Cancel', '#', :onclick => "hide_element($('#comment_edit_for_#{comment.id}'));" %>
    <%= submit_tag "Post", {:id => 'comment-submit', :class => 'btn primary'} %>
    </div>
  <% end %>
  <br class="clearing" />
</div>
<%- end %>

<script type="text/javascript">

function show_element(passed_element) {
  passed_element.show();
}

function hide_element(passed_element) {
  passed_element.hide();
}

</script>