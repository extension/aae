<div id="dashboard">
  <div class="span12">
    
    <p><%= link_to "Reports Home", expert_reports_home_path() %></p>
    
    <div id="location_filter">
      <div id="location_picker">
    	<%= select_tag "location_option", options_from_collection_for_select(@locations, "id", "name", params[:location_id]), {:prompt => "All locations", :name => "location_option"} %>
      </div>

      <div id="county_list">
        <% if params[:location_id].present? %>
          <%= select_tag("county_option", options_for_select(get_county_options(params[:location_id]), params[:county_id])) %>
        <% end %>
      </div>

      <%= select_tag "group_option", options_from_collection_for_select(@my_groups, "id", "name", params[:group_id]), {:prompt => "All groups", :name => "group_option"} %>
      <% select_tag "tag_option", options_from_collection_for_select(@my_tags, "id", "name", @tag_pref), {:prompt => "All tags (from your tag list)", :name => "tag_option"} %>
      <% if @unanswered_questions_count > 0 && @condition_array.present? %>
        <h5 class="highlight_unanswered"><span>There are <%= link_to "#{@unanswered_questions_count} Unanswered Questions", expert_home_unanswered_path(:override => true, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id])%> that match this filter.</span></h5>
      <% end %>

    </div>
  
    
    
    <div id="report_summary" class="">
      
      <h1><%= @condition_array.present? ? "Summary Report for #{@condition_array}" : "Summary Report - All Locations and Groups" %></h1>
      
      <% if @date.class == DateTime || @date.class == Date %>
        <h2><%= @date.strftime("%B, %Y") %></h2>
        
        <p>
          <%= link_to "Previous month", expert_reports_home_path(:year_month => @previous_year_month, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %> 
          <% if @following_year_month %>
  	      |  <%= link_to "Following month", expert_reports_home_path(:year_month => @following_year_month, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %>
  	      <% end %>
  	      
  	      <span class="pull-right">
  	        <%= link_to "Last Year", expert_reports_home_path(:year => (Time.now.year - 1).to_s, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %> | 
    	      <%= link_to "This Year", expert_reports_home_path(:year => (Time.now.year).to_s, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %>
    	      <span>
        </p>
        
      <% elsif @date.class == String %>
        <h2><%= @date %></h2>
        
        <p>
          <%= link_to "Current month", expert_reports_home_path(:year_month => (DateTime.now).strftime('%Y-%m'), :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %> 
  	      <span class="pull-right">
  	        <%= link_to "Last Year", expert_reports_home_path(:year => (Time.now.year - 1).to_s, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %> | 
    	      <%= link_to "This Year", expert_reports_home_path(:year => (Time.now.year).to_s, :location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id]) %>
    	      <span>
        </p>
      <% end %>
      
      

      
      <div id="data_summary">
        <h2>Question Activity</h2>
        <h3>
        <% if @questions_asked_count > 0 %> 
          <% if @date.class == DateTime || @date.class == Date %>
            <%= link_to(number_with_delimiter(@questions_asked_count, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year_month => @year_month, :filter => "asked")) %> 
          <% else %>
            <%= link_to(number_with_delimiter(@questions_asked_count, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year => @year_month, :filter => "asked")) %> 
          <% end %>
        <% else %>
           0
        <% end %>
 Questions Asked
        </h3>

        <h3>
        <%= @response_count %> Answers to 
        <% if @questions_answered_count > 0 %>
          <% if @date.class == DateTime || @date.class == Date %>
            <%= link_to(number_with_delimiter(@questions_answered_count, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year_month => @year_month, :filter => "answered")) %>
          <% else %>
            <%= link_to(number_with_delimiter(@questions_answered_count, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year => @year_month, :filter => "answered")) %>
          <% end %>
        <% else %>
            0
        <% end %>
        Questions by <%= @responder_count %> Experts
        </h3>
       
        <% if defined?(@location) && @location.present? && !defined?(@county) %>
          <br />
          <h2>Distribution of Activity for <%= @location.abbreviation %> Questions</h2>
          <h3>
          <%= @responders_in_state_count %> In-State Experts gave  <%= @responses_by_in_state_count %> Answers to 
          <% if @resolved_by_state_experts > 0 %>
            <% if @date.class == DateTime || @date.class == Date %>
              <%= link_to(number_with_delimiter(@resolved_by_state_experts, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year_month => @year_month, :filter => "in_state_experts")) %>
            <% else %>
              <%= link_to(number_with_delimiter(@resolved_by_state_experts, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year => @year_month, :filter => "in_state_experts")) %>
            <% end %>
          <% else %>
            0
          <% end %>
          Questions</h3>

          <h3>
          <%= @responders_outside_state_count %> Out-of-State Experts gave <%= @responses_by_outside_state_count %> Answers to 
          <% if @resolved_by_outside_state_experts > 0 %> 
            <% if @date.class == DateTime || @date.class == Date %>
              <%= link_to(number_with_delimiter(@resolved_by_outside_state_experts, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year_month => @year_month, :filter => "out_of_state_experts")) %>     
            <% else %>
              <%= link_to(number_with_delimiter(@resolved_by_outside_state_experts, :delimiter => ','), expert_reports_question_list_path(:location_id => params[:location_id], :county_id => params[:county_id], :group_id => params[:group_id], :year => @year_month, :filter => "out_of_state_experts")) %>
            <% end %>
          <% else %>
            0
          <% end %>
          Questions</h3>
        <% end %>
      </div>
      
      <% if @experts.size > 0 %>
        
      <h3>Activity for Experts located in <%= @condition_array.present? ? @condition_array : "No filters" %></h3>
      <table class="table table-striped table-bordered">
        <thead>
        <tr>
          <th>Expert</th>
          <th>Primary location</th>
          <th>Answered</th>
          <th>Assigned</th>
          <th>Last Active</th>
          <th>Metrics</th>
        <tr>
        </thead>  
        <% @experts.each do |member,answered_count| %>
          <tr>
            <td><%= link_expert_user_avatar(member, :thumb) %> <%= link_expert_user(member) %></td>
            <td>
              <% if member.location %>
                <% if member.county %>
                  <%= member.county.name %>, 
                <% end %>
                <%= member.location.abbreviation %>
              <% end %>
            </td>
            <td>
	          <% if @date.class == DateTime || @date.class == Date %>
	            <% member_answered_count = member.answered_count_by_year_month[@year_month] %>
                <span class="bignumber"><%= member_answered_count ? expert_question_list_link(member_answered_count, {id: member.id, filter: 'answered', year_month: @year_month}) : "0"%></span>
              <% else %>
                <% member_answered_count = member.answered_count_by_year[@year_month] %>
                <span class="bignumber"><%= member_answered_count ? expert_question_list_link(member_answered_count, {id: member.id, filter: 'answered', year: @year_month}) : "0"%></span>
              <% end %>
            </td>
            <td>
	          <% if @date.class == DateTime || @date.class == Date %>
                <% member_assigned_count = member.assigned_count_by_year_month[@year_month] %>
                <span class="bignumber">
                <%= member_assigned_count ? expert_question_list_link(member_assigned_count, {id: member.id, filter: 'assigned', year_month: @year_month}) : 0%></span>
              <% else %>
                <% member_assigned_count = member.assigned_count_by_year[@year_month] %>
                <span class="bignumber">
                <%= member_assigned_count ? expert_question_list_link(member_assigned_count, {id: member.id, filter: 'assigned', year: @year_month}) : 0%></span> 
              <% end %>
            </td>
            <td><span class="downplay">Last active: <%= time_ago_in_words(member.last_active_at) %> ago</span></td>
            <td><%= link_to('Full report',expert_expert_report_path(member.id)) %></td>
            </tr>

        <% end %>
        </table>
      <% else %>
        <!-- <p>There are no experts in this location</p> -->
      <% end %>
      
  </div>
</div>

<script class="code" type="text/javascript">
  
  function set_params(param, id) {
    var pathname = window.location.pathname;
    var params = new Array();
    
    if (param == "location_id") {
      var location_id = id;
      var county_id = "";
    } else {
      var location_id = (param == "location_id" ? id : "<%= params[:location_id] %>");
      var county_id = (param == "county_id" ? id : "<%= params[:county_id] %>");
    }
    var group_id = (param == "group_id" ? id : "<%= params[:group_id] %>");
    var year_month = "<%= params[:year_month] %>"
    var year = "<%= params[:year] %>"
    
    if (year_month) {
      params.push("year_month=" + year_month);
    }
    if (location_id) {
      params.push("location_id=" + location_id);
    }      
    if (county_id) {
      params.push("county_id=" + county_id);
    }
    if (group_id) {
      params.push("group_id=" + group_id);
    }
    if (year) {
      params.push("year=" + year);
    }
    return pathname + "?" + params.join("&");
	}


  $("#location_option").change(function() {
    var location_id = $('select#location_option :selected').val();
    new_url = set_params("location_id", location_id);
    window.location.href = new_url;
    return false;
  });

  $("#county_option").change(function() {
    var county_id = $('select#county_option :selected').val();
    new_url = set_params("county_id", county_id);
    window.location.href = new_url;
    return false;
  });

  $("#group_option").change(function() {
    var group_id = $('select#group_option :selected').val();
    new_url = set_params("group_id", group_id);
    window.location.href = new_url;
    return false;
  });

</script>