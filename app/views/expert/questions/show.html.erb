<% @page_title = raw("\"#{@question.title.gsub(/[[:space:]]/, ' ')}\"") %>

<% @working_on_it = true %>

<div id="working_on_this">
  <% if current_user == @question.assignee %>
    <% if @working_on_it %>
      <h3>You've got this question <em>(<%= time_ago_in_words(DateTime.now + 2.hours) %> left)</em></h3>
      <p>If you decide you can't answer it, please assign it someone who can or hand it off to a Question Wrangler.</p>
      <p><%= link_to "Give me another 2 hours", "", :class => "btn" %></p>
    <% else %>
      <h3>This question is currently up for grabs</h3>
      <p>Yes, it is assigned to you, but unless you click the "I'm working on this" button, another expert may go ahead and answer it. Please tell us if you are actively working on it.</p>
      <p><%= link_to "I'm working on this (Click and it's yours for 2 hours.)", "", :class => "btn" %></p>
    <% end %>
  <% else %>
    <% if @working_on_it %>
      <h3><em>Heads up: Answer In Progress</em> <%= @question.assignee %> is working on this question right now.</h3>
      <p>They still have <%= time_ago_in_words(DateTime.now + 2.hours) %> left to answer it. If it's not answered or updated by then, you can take a stab at it. Thanks!</p>
    <% else %>
      <h3>This question is <%= time_ago_in_words(@question.created_at) %> old and up for grabs</h3>
      <p>It is assigned to someone, but that person has not clicked the "I'm working on this" button or their working time has expired on it. You are welcome to go ahead and answer it.</p>
      <p><%= link_to "I want this question (Assign it to me and take it 'off the market' for two hours.)", "", :class => "btn" %></p>
    <% end %>
<% end %>
</div>


<div id="main" class="span8">
  <div id="question_wrapper">
    <p id="aaeid">
      <% if !@question.is_private %>
        <span class="tag tag-public">Public</span>
      <% end %> 
      Question #<%= @question.id %> - <%= link_to "Public View", question_path(@question.id) %> | <%= link_to "Edit", edit_expert_question_path(@question.id) %> | <%= link_to "Revision History", history_expert_question_path(@question.id) %>
    </p>

    <%= render :partial => 'question_main' %>

    <h2>Comments</h2>
    <p>Comments can be posted on public questions</p>
    <div id="comment-list">
	  <%= render :partial => '/comments/comment_list', :locals => {:comment_list => @question.comments, :parent_comment => nil} %>
	</div>
	   
    <div id="history">
      <%= render :partial => 'history' %>
    </div>
  </div>
</div>

<div id="secondary" class="span4">

<div id="notificationprefs">
  <%= render :partial => 'activity_notification' %>
</div>
  
  
  <div id="privacy_status" class="dontprintme">
    <%= render :partial => 'privacy_status' %>
  </div>
  

  <aside class="dontprintme <%= (@question.status_state == Question::STATUS_REJECTED) ? "rejected" : "" %>">
    <% if @question.status_state == Question::STATUS_REJECTED %>
      <h3 class="rejected">This Question Has Been Rejected</h3>
      <h3><strong>Reason:</strong> <%= wrap_text(@question.current_response) %></h3>
      <p>
    	  <% if @question.current_resolver_id == User.system_user_id %>
    	    System
    	  <% else %>
    	    <%= link_to expert_user_path(@question.current_resolver_id) do %>
            <%= link_expert_user_avatar(@question.current_resolver, :thumb) %> <%= link_to @question.current_resolver.name, expert_user_path(@question.current_resolver_id) %>
          <% end %>
    	    
    	  <% end %>
    	</p>
      
      <p><%= button_to 'Reactivate Question', reactivate_expert_question_path(@question.id), :class => "btn" %></p>
        
	<% elsif @question.status_state == Question::STATUS_NO_ANSWER %>
	   <h3>A canned response was used to answer this question</h3>
	   <div class="question_actions">
       <p><%= link_to "Reopen by reassigning", reassign_expert_question_path(@question.id), :class => "btn btn-primary" %></p>
     </div>
	   
	<% elsif @question.status_state == Question::STATUS_CLOSED %>
	   	<h3>This question has been closed</h3>
      <p>
        <strong>Closed by: </strong> 
        <% if @question.current_resolver_id == User.system_user_id %>
          System
        <% else %>
          <%= link_to @question.current_resolver.name, expert_user_path(@question.current_resolver_id) %>
        <% end %>
      </p>
      <p><strong>Comment:</strong> <%= wrap_text(@question.current_response) %></p>
      <p><%= button_to 'Reactivate Question', reactivate_expert_question_path(@question.id), :class => "btn btn-primary" %></p>
      
	<% elsif @question.status_state == Question::STATUS_RESOLVED %>
	    <h3>This question has been resolved</h3>
	    <div class="question_actions last">
        <p><%= link_to "Reopen by reassigning", reassign_expert_question_path(@question.id), :class => "btn btn-primary" %></p>
      </div>
	    
	<% else %>
      <div class="question_actions">
        <span><%= link_to "Send an Answer", answer_expert_question_path(@question.id), :class => "btn btn-primary" %></span>
        <span><%= link_to "Close", close_out_expert_question_path(@question.id), :class => "btn" %></span>
        <span><%= link_to "Reject", reject_expert_question_path(@question.id), :class => "btn" %></span>
      </div>
     <% end %>
  </aside>
  

  
  <% if @question.status_state != Question::STATUS_REJECTED %>
    <aside>
      <% if (@question.status_state == Question::STATUS_RESOLVED) || (@question.status_state == Question::STATUS_NO_ANSWER) %>
        <h3>Last response by</h3>
      <% else %>
        <h3>Assigned to</h3>
      <% end %>
  
      <% if @question.assignee.present? %>
        <%= link_expert_user_avatar(@question.assignee, :thumb) %> <%= link_expert_user(@question.assignee) %>
      <% elsif @question.assigned_group.present? %>
        <%= link_expert_group_avatar(@question.assigned_group, :thumb) %> <%= link_to @question.assigned_group.name, expert_group_path(@question.assigned_group.id) %>
      <% end %>
      
      
      <%= link_to "Reassign", reassign_expert_question_path(@question.id), :class => "btn" %>
      
    </aside>
    
    <% if !@question.assignee.blank? %>
      <aside class="">
        <div id="associated_group">
          <%= render :partial => 'associated_group' %>
        </div>      
      </aside>
    <% end %>
    
  <% end %>
  
  
  
  
  <aside class="nobg dontprintme">
    <h4>Related Questions</h4>
    <% @question.similar_questions.each do |question,score| %>
      <p><%= link_to(format_text_for_display(question.title), expert_question_path(question.id)) %></p>
    <% end %>
  </aside>
  
</div>