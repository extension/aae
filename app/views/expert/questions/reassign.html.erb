<% @page_title = "Reassign"%>

<div class="span12">
  
  <div id="reassign_header">
    <h3><%= link_to "Question ##{@question.id}", expert_question_url(@question) %></h3>
    <h1>Reassign this question <%= link_to "Cancel", expert_question_path(@question.id), :class => "btn" %></h1>
    <p><%= link_to "Try the new reassignment interface", reassignbeta_expert_question_path(@question.id), :class => "btn" %></p>
  </div>
  
  <div id="reassign_actions">
    <% if (@question.assignee != current_user) || 
      (((@question.status_state == Question::STATUS_RESOLVED) || (@question.status_state == Question::STATUS_NO_ANSWER)) && (@question.assignee == current_user)) %>
      <p><%= link_to "Assign to me", assign_expert_question_path(:id => @question.id, :assignee_id => current_user.id), :method => :post, :class => "btn-primary btn" %></p>
    <% end %>
    <p><%= button_to "Assign to a Question Wrangler", assign_to_wrangler_expert_question_path(@question.id), :class => "btn btn-primary" %></p>

    <input id="expert_name" placeholder="Search by name for Experts or Groups" />
  </div>


<% if (!@question.location.present?) && (@question.tags.size == 0) %>
  <h3 class="nomatches">We can't recommendation any experts or groups because this question does not have any tags or a location. Please add some tags to generate some matches.</h3>
<% else %>

<div id="reassign_wrapper">
  
  <div id="reassign_tag_list_wrapper">
  <div class="row-fluid">
    <div class="span4">
      <h2>Best Matches</h2>
    </div>
    
    <div class="span8">
      <% filter_terms = [] %>
        <ul id="reassign_tag_list">
        
        <% if @question.location.present? %>
          <% filter_terms <<  @question.location.name %> 
          <li><span class="tag tag-geography"><em class="reassign_tag_list_item"><%= filter_terms.count %></em> <%= @question.location.name %> <span class="matching_code">(<%= @question.location.abbreviation %>)</span></span></li>
        <% end %>
  
        <% if @question.county.present? %>
          <% filter_terms <<  @question.county.name %> 
          <li><span class="tag tag-geography"><em class="reassign_tag_list_item"><%= filter_terms.count %></em> <%= "#{@question.county.name}" %> <span class="matching_code">(Co.)</span></span></li>
        <% end %>
  
        <% if @question.tags.size > 0 %>
          <% @question.tags.each do |tag| %>
            <% filter_terms <<  tag.name %> 
            <li><span class="tag tag-topic"><em class="reassign_tag_list_item"><%= filter_terms.count %></em> <%= tag.name %></span></li>
          <% end %>
        <% end %>
        
        </ul>
    </div>
  </div>
  </div>
  
  <div class="assignment_match_header <% filter_terms.count %>">
    <div class="row-fluid">
    
      <div class="span4"><h2>Best Matches</h2></div>
        
      <div class="span8">
      <table class="table table-bordered">
      <tr class="matching_wrapper term_count_<%= filter_terms.count %>">
      <% filter_terms.to_enum.with_index(1).each do |term, index| %>
        <% if @question.county.present? && term == @question.county.name %>
          <td class="match location_match"><em class="matching_term"><%= @question.county.name %></em></td>
        <% elsif @question.location.present? && term == @question.location.name %>
          <td class="match location_match"><em class="matching_term"><%= @question.location.abbreviation %></td>
        <% else %>
          <td class="match tag_match"><em class="matching_term"><%= term %></em></td>
        <% end %>
      <% end %>
      </tr>
      </table>
      </div>
  </div>
  </div>
  
  
<% if @groups.size > 0 %>
  	<% @groups.each do |group| %>
      <% group_expertise_counties = group.expertise_counties %>
      <% group_expertise_locations = group.expertise_locations %>
      <% group_tags = group.tags %>

       <div class="assignment_match <% filter_terms.count %>">
        <div class="row-fluid">
        
          <div class="span4">
          <%= link_to link_expert_group_avatar_group_label(group, :thumb), group_assign_options_expert_question_path(:id => @question.id, :group_id => group.id) %> <%= link_to group.name, group_assign_options_expert_question_path(:id => @question.id, :group_id => group.id) %>
          </div>
          
          <div class="span8">
          <table class="table table-bordered">
          <tr class="matching_wrapper term_count_<%= filter_terms.count %>">
          <% filter_terms.to_enum.with_index(1).each do |term, index| %>
	          <% if @question.county.present? && term == @question.county.name && group_expertise_counties.include?(@question.county) %>
	            <td class="match location_match"><em class="matching_term">Co.</em> <i>yes</i></td>
	          <% elsif @question.location.present? && term == @question.location.name && group_expertise_locations.include?(@question.location) %>
	            <td class="match location_match"><em class="matching_term"><%= @question.location.abbreviation %> <i>yes</i></td>
	          <% elsif group_tags.map(&:name).include?(term) %>
	            <td class="match tag_match"><em class="matching_term"><%= term %></em> <i>yes</i></td>
	          <% else %>
	            <td class="nomatch"><em class="matching_term"><%= index %></em> <i>no</i></td>
	          <% end %>
          <% end %>
          </tr>
          </table>
          </div>
      </div>
      </div>

    <% end %>

<% end %>

<% if @experts.size > 0 %>
      <% @experts.each do |expert| %>
        <% expert_expertise_counties = expert.expertise_counties %>
        <% expert_expertise_locations = expert.expertise_locations %>
        <% expert_tags = expert.tags %>
        
        <div class="assignment_match <% filter_terms.count %>">
        <div class="row-fluid">
        
            <div class="span4">
            <%= link_to get_avatar_for_user(expert, :thumb), assign_options_expert_question_path(:id => @question.id, :expert_id => expert.id) %> <%= link_to raw(expert_user(expert)), assign_options_expert_question_path(:id => @question.id, :expert_id => expert.id) %>
            <br>
            <span class="handling_rate"><%= display_handling_rate(@handling_rates[expert.id]) %></span>
            <p class="reasssign"><%= display_handling_rate_bar(@handling_rates[expert.id]) %></p>
            <span class="downplay">last active <%= time_ago_in_words(expert.last_active_at) %> ago</span>
            </div>
            
            <div class="span8">
            <table class="table table-bordered">
            <tr class="matching_wrapper term_count_<%= filter_terms.count %>">
            <% filter_terms.to_enum.with_index(1).each do |term, index| %>
  	          <% if @question.county.present? && term == @question.county.name && expert_expertise_counties.include?(@question.county) %>
  	            <td class="match location_match"><em class="matching_term">Co.</em> <i>yes</i></td>
  	          <% elsif @question.location.present? && term == @question.location.name && expert_expertise_locations.include?(@question.location) %>
  	            <td class="match location_match"><em class="matching_term"><%= @question.location.abbreviation %> <i>yes</i></td>
  	          <% elsif expert_tags.map(&:name).include?(term) %>
  	            <td class="match tag_match"><em class="matching_term"><%= term %></em> <i>yes</i></td>
  	          <% else %>
  	            <td class="nomatch"><em class="matching_term"><%= index %></em> <i>no</i></td>
  	          <% end %>
            <% end %>
            </tr>
            </table>
            </div>
        </div>
        </div>
      <% end %>

<% else %>
  <p>No County and Tag Matches</p>
<% end %>
</div>


<% end %>

</div>

<!-- <div class="span3"> -->
<!-- </div> -->

<script class="code" type="text/javascript">
/* Append the function to the "document ready" chain */
jQuery(function($) {
  /* when the #expert search form submits */
  $("#expert_search_by_name").submit(function() {
	/* stop form from submitting normally */
	event.preventDefault();
    /* make a call to search experts and replace expert result contents */
    $.post('<%= expert_search_by_name_path %>', { expert_search: $("#expert_name").val(), question_id: <%= @question.id %>}, function(data) {
      $("#expert_search_results").html(data);
    });
  });
})

    // create an instance of autocomplete plus a hack for using the 'enter' key instead of direct selection
		$("#expert_name").autocomplete({
      source: "/ajax/experts",
			minLength: 2,
			select: function(e, ui) {
			  if(ui.item.class_type == "User") {
			    window.location = '<%= assign_options_expert_question_url(:id => @question.id) %>?expert_id=' + ui.item.id
			  }
			  else if (ui.item.class_type == "Group") {
		        window.location = '<%= group_assign_options_expert_question_url(:id => @question.id) %>?group_id=' + ui.item.id
		      }
			}
		}).keypress(function(e) {
      if (e.keyCode === 13) {
        window.location = '<%= assign_options_expert_question_url(:id => @question.id) %>?expert_id=' + this.value
      }
    });

</script>